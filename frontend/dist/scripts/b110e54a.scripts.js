"use strict";function Paper(a){this.selected=!1,angular.extend(this,a),this.init()}angular.module("paperchaseApp",["ngCookies","ngResource","ngSanitize","ngRoute","infinite-scroll","ui.bootstrap","ngBase64","LocalStorageModule"]).config(["localStorageServiceProvider",function(a){a.setPrefix("paperchase")}]).config(["$routeProvider","$locationProvider","$httpProvider","$compileProvider",function(a,b,c,d){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/subscriptions",{templateUrl:"views/subscriptions.html",controller:"SubscriptionpageCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"RegisterCtrl"}).otherwise({redirectTo:"/"}),c.interceptors.push(["$q","$location",function(a,b){return{request:function(a){return a.headers["X-StatusOnLoginFail"]="403",a},responseError:function(c){return 403===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}]),d.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|papers):/)}]),angular.module("paperchaseApp").controller("MainCtrl",["$scope","Papers","Journals","$window",function(a,b,c,d){a.papers=new b,a.journals=c,a.showSubscriptions=!1,a.toggleUnread=function(){a.papers=new b(!a.papers.unread,a.papers.since),a.papers.nextPage()},a.markAllRead=function(){a.papers.markAllRead(),a.papers=new b(a.papers.unread,a.papers.since),a.papers.nextPage()},a.unsubscribe=function(){a.journals.toggleSubscriptions(a.papers.selected.journal.id,!1),a.papers=new b(a.papers.unread,a.papers.since),a.papers.nextPage()},a.filterForJournal=function(c){a.papers=new b(a.papers.unread,a.papers.since,c),a.papers.nextPage()},a.$on("selected_new_item",function(b,c){a.scrollInto("paper"+c)}),a.scrollInto=function(a){a||d.scrollTo(0,0);var b=document.getElementById(a);b||(b=document.getElementsByName(a),b=b&&b.length?b[0]:null),b&&b.scrollIntoView(!1)},a.papersActive=!0,a.$on("keyPress",function(b,c){switch(c){case"up":a.papersActive===!0&&a.papers.prev();break;case"down":a.papersActive===!0&&a.papers.next();break;case"left":a.papersActive===!1&&(a.papersActive=!0);break;case"right":a.papersActive===!0&&(a.papersActive=!1);break;case"space":}})}]),angular.module("paperchaseApp").controller("SubscriptionsCtrl",["$scope","Journals","CategoryAPI",function(a,b,c){a.journals=b,a.journals.getJournals(),a.categories=c.getCategories(),a.subscribed={name:"All",value:void 0},a.subscriptionFilter=function(b){switch(a.subscribed.value=b,b){case!0:a.subscribed.name="Subscribed";break;case!1:a.subscribed.name="Unsubscribed";break;default:a.subscribed.name="All"}},a.resetSubcategory=function(){a.subcategory={name:"All",id:void 0}},a.resetSubcategory(),a.selectCategory=function(b){a.category=b,a.resetSubcategory()},a.resetCategory=function(){a.category={name:"All",id:void 0,subcategories:[]},a.resetSubcategory()},a.resetCategory(),a.subscribe=function(b,c){a.journals.toggleSubscriptions(c,!0)},a.unsubscribe=function(b,c){a.journals.toggleSubscriptions(c,!1)}}]),angular.module("paperchaseApp").controller("LoginCtrl",["$scope","$http","$location","UserServices",function(a,b,c,d){a.alert=void 0,a.closeAlert=function(){a.alert=void 0},a.loginPC=function(){d.verifyCredentials(a.email,a.password).success(function(){d.setCredentials(a.email,a.password),c.path("/home")}).error(function(){a.alert={type:"danger",msg:"Username or password incorrect."}})}}]),angular.module("paperchaseApp").controller("RegisterCtrl",["$scope","$http","UserServices",function(a,b,c){a.alert=void 0,a.closeAlert=function(){a.alert=void 0},a.registerPC=function(){c.register(a.email,a.password).success(function(){a.alert={type:"success",msg:'Congratulations! You will receive a confirmation email shortly. You can login <a href="#/login">here</a>'}}).error(function(b,c){409===c&&(a.alert={type:"danger",msg:"The email address is already registered."})})}}]),angular.module("paperchaseApp").controller("SuggestionCtrl",["$scope","CategoryAPI",function(a,b){a.alert=void 0,a.closeAlert=function(){a.alert=void 0},a.categories=b.getCategories(),a.category=[],a.subcategories=[],a.subcategory=[],a.submitted=function(){a.alert={type:"success",msg:'The developers will review the information in your email, add the journal and contact you. You can now return to the <a href="#/home">home page</a>'}}}]),angular.module("paperchaseApp").controller("GlobalCtrl",["$scope","$location","UserServices",function(a,b,c){a.isLogged=function(){return c.isLogged()},a.logoutPC=function(){c.clearCredentials(),b.path("/login")},a.isActive=function(a){return a===b.path()},a.keyPressed=function(b){a.$broadcast("keyPress",b)}}]),angular.module("paperchaseApp").controller("ModalCtrl",["$scope","$modalInstance",function(a,b){a.close=function(){b.close()}}]),angular.module("paperchaseApp").directive("pcKeydown",function(){return function(a,b,c){b.bind("keydown",function(b){switch(b.keyCode){case 34:case 39:return a.$apply(c.pcRight);case 40:return a.$apply(c.pcDown);case 32:return b.preventDefault(),a.$apply(c.pcSpace);case 33:case 37:return a.$apply(c.pcLeft);case 38:return a.$apply(c.pcUp);case 85:}})}}),angular.module("paperchaseApp").directive("pwCheck",function(){return{require:"ngModel",link:function(a,b,c,d){var e=b.inheritedData("$formController")[c.pwCheck];d.$parsers.push(function(a){return a===e.$viewValue?(d.$setValidity("pwmatch",!0),a):(d.$setValidity("pwmatch",!1),void 0)}),e.$parsers.push(function(a){return d.$setValidity("pwmatch",a===d.$viewValue),a})}}}),angular.module("paperchaseApp").filter("escape",function(){return window.encodeURIComponent}),angular.module("paperchaseApp").filter("htmlToPlainText",function(){return function(a){return String(a).replace(/<(?:.|\n)*?>/gm,"")}}),angular.module("paperchaseApp").factory("CategoryAPI",["$http","$resource",function(a,b){return b("/api/categories/:categoryId/:resource",{},{getCategories:{method:"GET",isArray:!0,cache:!0},getSubcategories:{method:"GET",params:{categoryId:"@id",resource:"subcategories"},isArray:!0,cache:!0}})}]),angular.module("paperchaseApp").factory("SubscriptionAPI",["$http","$resource",function(a,b){return b("/api/subscriptions/:journalId",{},{getSubscribedJournals:{method:"GET",isArray:!0},subscribe:{method:"POST",params:{journalId:"@id"}},unsubscribe:{method:"DELETE",params:{journalId:"@id"}}})}]),angular.module("paperchaseApp").factory("PaperAPI",["$http","$resource",function(a,b){return b("/api/papers/:paperId",{},{getPapers:{method:"GET",isArray:!0},getPapersForJournal:{url:"/api/journals/:journalId/papers",params:{journalId:"@id"},method:"GET",isArray:!0},getPaper:{method:"GET",params:{paperId:"@id"}},getUnreadList:{url:"/api/unread_papers",method:"GET",isArray:!0},markUnread:{url:"/api/unread_papers",method:"PUT",isArray:!0},markRead:{url:"/api/read_papers",method:"PUT",isArray:!0},markAllRead:{url:"/api/read_papers/mark_all_read",method:"PUT"}})}]),Paper.prototype.init=function(){this.created=new Date(this.created),this.read=null!==this.readAt},angular.module("paperchaseApp").factory("Papers",["PaperAPI","Journals","$injector","$q",function(a,b,c,d){var e=b,f=function(a,b,c){this.items=[],this.busy=!1,this.readCount=0,this.selected=null,this.selectedId=-1,this.page=1,this.numberOfPages=1;var d=b;this.__defineGetter__("since",function(){return d});var e=void 0!==a?a:!0;this.__defineGetter__("unread",function(){return e});var f=c;this.__defineGetter__("journalId",function(){return f})};return f.prototype.nextPage=function(){if(!(this.busy||this.page>this.numberOfPages)){this.busy=!0;var b={page:this.page};this.unread===!0&&(b.unread=!0),void 0!==this.since&&(b.since=this.since);var c,f=e.subscriptions;void 0===this.journalId?c=a.getPapers(b,function(a,b){this.numberOfPages=b()["x-total-count"]}.bind(this)):(b.journalId=this.journalId,c=a.getPapersForJournal(b,function(a,b){this.numberOfPages=b()["x-total-count"]}.bind(this))),d.all([c.$promise,f.$promise]).then(function(){var a,b;for(a=c.length-1;a>=0;a-=1)b=new Paper(c[a]),b.read===!0&&(this.readCount+=1),b.journal=e.findSubscription(b.journalId),delete b.journalId,this.items.push(b);this.page=this.page+1,this.busy=!1}.bind(this))}},f.prototype.hasPrev=function(){return this.selected?this.selectedId>0:!0},f.prototype.hasNext=function(){return this.selected?this.selectedId<this.items.length-1:!0},f.prototype.selectItem=function(b){var f=0,g=c.get("$rootScope"),h=a.getPaper({paperId:b}),i=e.subscriptions;for(d.all([h.$promise,i.$promise]).then(function(){this.selected=new Paper(h),this.selected.journal=e.findSubscription(this.selected.journalId),delete this.selected.journalId,this.selected.read||this.toggleRead()}.bind(this)),this.selectedId>=0&&(this.items[this.selectedId].selected=!1);f<this.items.length;){if(this.items[f].id===b){this.selectedId=f;break}f+=1}this.items[this.selectedId].selected=!0,g&&g.$broadcast("selected_new_item",b),this.hasNext()||this.nextPage()},f.prototype.prev=function(){this.hasPrev()&&this.selectItem(this.items[this.selected?this.selectedId-1:0].id)},f.prototype.next=function(){this.hasNext()&&this.selectItem(this.items[this.selected?this.selectedId+1:0].id)},f.prototype.toggleRead=function(){this.selected.read===!1?a.markRead({readPapers:[this.selected.id]}):a.markUnread({unreadPapers:[this.selected.id]}),this.selected.read=!this.selected.read,this.items[this.selectedId].read=!this.items[this.selectedId].read},f.prototype.markAllRead=function(){a.markAllRead()},f}]),angular.module("paperchaseApp").factory("UserServices",["$http","localStorageService","$base64","$cookies",function(a,b,c,d){var e={isLogged:!1},f=b.get("authData");return f&&(a.defaults.headers.common.Authorization="Basic "+f,e.isLogged=!0),a.defaults.headers.post["X-CSRFToken"]=d._csrf_token,a.defaults.headers.delete={"X-CSRFToken":d._csrf_token},{verifyCredentials:function(b,d){var e=c.encode(b+":"+d),f="/api/users";return a({method:"GET",url:f,headers:{Authorization:"Basic ".concat(e)}})},setCredentials:function(d,f){var g=c.encode(d+":"+f),h="/api/users/token";a({method:"GET",url:h,headers:{Authorization:"Basic ".concat(g)}}).success(function(d){g=c.encode(d.token+":unused"),a.defaults.headers.common.Authorization="Basic "+g,e.isLogged=!0,b.set("authData",g),b.set("authExpire",d.duration)}).error()},clearCredentials:function(){document.execCommand("ClearAuthenticationCache"),a.defaults.headers.common.Authorization="Basic ",e.isLogged=!1,b.remove("authData")},isLogged:function(){return e.isLogged},register:function(b,c){var d={email:b,password:c};return a({url:"/api/register",method:"POST",data:angular.toJson(d),headers:{"Content-Type":"application/json"}})}}}]),angular.module("paperchaseApp").service("JournalAPI",["$http","$resource",function(a,b){return b("/api/journals/:journalId",{},{getJournals:{method:"GET",isArray:!0,cache:!0},getJournal:{method:"GET",params:{journalId:"@id"},isArray:!1,cache:!0}})}]);var belongsTo=function(a,b){var c;for(c=0;c<b.length;c+=1)if(a===b[c])return!0;return!1};angular.module("paperchaseApp").filter("categoryFilter",function(){return function(a,b,c){if(!b.id)return a;var d=[];return angular.forEach(a,function(a){if(c.id)belongsTo(c.id,a.categories)&&d.push(a);else if(a.categories.sort(function(a,b){return a-b}),belongsTo(b.id,a.categories))d.push(a);else{b.subcategories.sort(function(a,b){return a.id-b.id});for(var e=0,f=0;e<a.categories.length&&f<b.subcategories.length;)a.categories[e]<b.subcategories[f].id?e+=1:a.categories[e]>b.subcategories[f].id?f+=1:(d.push(a),e+=1,f+=1)}}),d}}),angular.module("paperchaseApp").factory("Journals",["SubscriptionAPI","JournalAPI","$modal","$location",function(a,b,c,d){var e=function(a,b){for(var c,d=0;d<b.length;){if(b[d].id===a){c=b[d];break}d+=1}return c},f=function(){if("/subscriptions"!==d.path()){var a=c.open({templateUrl:"views/emptysubdialog.html",controller:"ModalCtrl",resolve:{}});a.result.then(function(){d.path("/subscriptions")})}},g=function(){this.journals=[];var b=function(){return a.getSubscribedJournals(function(a){0===a.length&&f()})};this.__defineGetter__("subscriptions",function(){return void 0===this._subscriptions&&(this._subscriptions=b()),this._subscriptions}),this.refreshSubscriptions=function(){this._subscriptions=b()}};return g.prototype.getJournals=function(){this.journals=b.getJournals()},g.prototype.findJournal=function(a){return e(a,this.journals)},g.prototype.findSubscription=function(a){return e(a,this._subscriptions)},g.prototype.toggleSubscriptions=function(b,c){var d=this.findJournal(b);c===!0?a.subscribe({journalId:b},function(a){d.subscribed=a.subscribed}):a.unsubscribe({journalId:b},function(a){d.subscribed=a.subscribed}),this.refreshSubscriptions()},new g}]),angular.module("paperchaseApp").controller("SubscriptionpageCtrl",["$scope",function(a){a.showLeftSide=!0}]);